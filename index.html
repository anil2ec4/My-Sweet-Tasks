<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Sweet Tasks</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom font and styles for the new theme */
        body { font-family: 'Poppins', sans-serif; }
        .task-item:hover .actions { opacity: 1; }
        
        /* Sweet & Modern Theme Custom Styles */
        .pink-glow-focus:focus-within,
        .pink-glow-focus:focus {
            box-shadow: 0 0 0 3px rgba(219, 39, 119, 0.4);
            border-color: #db2777;
        }
        .pink-glow-focus-btn:focus {
             box-shadow: 0 0 0 3px rgba(219, 39, 119, 0.4);
        }

        /* Filter & Tag Buttons */
        .filter-btn, .tag-btn { transition: all 0.2s ease-in-out; }
        .filter-btn.active { background-color: #db2777; color: white; box-shadow: 0 4px 12px -2px rgba(219, 39, 119, 0.4); transform: translateY(-2px); }
        .tag-btn.active { background-color: #9d174d; color: white; box-shadow: 0 4px 12px -2px rgba(157, 23, 77, 0.5); transform: translateY(-2px); }
        .tag-btn { background-color: #fdf2f8; color: #9d174d; }

        /* Priority Borders */
        .priority-high { border-left: 4px solid #f43f5e; } /* rose-500 */
        .priority-medium { border-left: 4px solid #e879f9; } /* fuchsia-400 */
        .priority-low { border-left: 4px solid #a78bfa; } /* violet-400 */
        
        /* Overdue Date */
        .overdue-date { color: #be123c; font-weight: 700; }

        /* Rendered Tag in List */
        .rendered-tag { background-color: #fdf2f8; color: #9d174d; cursor: pointer; transition: background-color 0.2s; }
        .rendered-tag:hover { background-color: #fce7f3; }

        /* Progress Circle */
        .progress-ring__circle { transition: stroke-dashoffset 0.5s; transform: rotate(-90deg); transform-origin: 50% 50%; }

        /* Pomodoro Modal */
        .pomodoro-modal-bg { background-color: rgba(50, 10, 30, 0.5); backdrop-filter: blur(4px); }
        .pomodoro-modal { transform: scale(0.95); opacity: 0; transition: transform 0.2s ease-out, opacity 0.2s ease-out; }
        .pomodoro-modal.open { transform: scale(1); opacity: 1; }

        /* Celebration Animation */
        @keyframes celebration-fade-in {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        .celebration-anim {
            animation: celebration-fade-in 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
    </style>
</head>
<body class="bg-rose-50 flex items-center justify-center min-h-screen transition-colors duration-300 p-4">

    <!-- Main Container -->
    <div id="app-wrapper" class="w-full max-w-lg mx-auto">
    
        <!-- Connect Screen (Initially Visible) -->
        <div id="connect-container" class="text-center p-8 bg-white/80 backdrop-blur-xl border border-white/30 rounded-2xl shadow-2xl shadow-rose-200/50">
             <span class="text-6xl mb-4 inline-block">ðŸ’–</span>
             <h1 class="text-3xl font-bold text-slate-800 mb-2">My Sweet Tasks</h1>
             <p class="text-slate-500 mb-6">Please connect your wallet to manage your tasks.</p>
             <button id="connect-wallet-btn" class="bg-pink-600 text-white font-bold py-3 px-8 rounded-full hover:bg-pink-700 transition-transform transform hover:scale-105 pink-glow-focus-btn text-lg">
                Connect Wallet
             </button>
        </div>

        <!-- App Screen (Initially Hidden) -->
        <div id="app-container" class="hidden w-full bg-white/80 backdrop-blur-xl border border-white/30 rounded-2xl shadow-2xl shadow-rose-200/50 p-6 md:p-8">
            
            <!-- Header with Profile & Gamification -->
            <div class="flex items-center justify-between mb-6">
                <!-- User Profile Info -->
                <div id="profile-header" class="flex items-center gap-3 min-w-0">
                    <img id="profile-avatar" src="https://placehold.co/40x40/fbcfe8/db2777?text=P" class="w-10 h-10 rounded-full border-2 border-pink-200 flex-shrink-0">
                    <div class="min-w-0">
                        <p id="profile-name" class="font-bold text-slate-700 truncate">Username</p>
                        <p id="profile-address" class="text-xs text-slate-500 font-mono">0x...</p>
                    </div>
                </div>
                <button id="disconnect-btn" class="bg-rose-100 text-slate-600 font-semibold py-2 px-4 rounded-lg hover:bg-rose-200 transition flex-shrink-0">
                    Disconnect
                </button>
            </div>
            
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-slate-800">My Sweet Tasks</h1>
                    <p class="text-rose-400" id="today-date"></p>
                </div>
                <div id="progress-container" class="relative w-16 h-16 cursor-pointer flex-shrink-0" title="Today's Progress">
                    <svg class="w-full h-full" viewBox="0 0 36 36">
                        <path class="text-rose-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3.5"></path>
                        <path id="progress-ring" class="progress-ring__circle text-pink-500" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3.5" stroke-dasharray="100, 100" stroke-dashoffset="100" stroke-linecap="round"></path>
                    </svg>
                    <div id="progress-text" class="absolute top-0 left-0 w-full h-full flex flex-col items-center justify-center text-center">
                        <span id="daily-completed-count" class="text-lg font-extrabold text-pink-600">0</span>
                        <span class="text-xs text-slate-500 font-medium">Done</span>
                    </div>
                </div>
            </div>

            <!-- Add Task Form -->
            <div id="add-task-container" class="space-y-4 mb-4">
                <div class="rounded-lg border border-rose-200 p-3 pink-glow-focus">
                    <input type="text" id="task-input" placeholder="Plan a fabulous day..." class="w-full bg-transparent text-slate-700 focus:outline-none placeholder-rose-400" autocomplete="off">
                </div>
                 <!-- Tag Selector -->
                <div id="tag-selector" class="flex flex-wrap gap-2">
                    <button data-tag="Work" class="tag-btn font-semibold py-2 px-4 rounded-full flex items-center gap-2">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 3.75A2.75 2.75 0 018.75 1h2.5A2.75 2.75 0 0114 3.75v.443c.572.055 1.14.122 1.706.2C17.053 4.582 18 5.75 18 7.07v3.863c0 1.32-0.947 2.488-2.294 2.667-0.566.078-1.134.145-1.706.2v.443c0 2.071-1.679 3.75-3.75 3.75h-2.5A2.75 2.75 0 016 14.25v-.443a8.024 8.024 0 01-1.706-.2C2.947 13.418 2 12.25 2 10.933V7.07c0-1.32 0.947-2.488 2.294-2.667A8.024 8.024 0 016 4.193v-.443zM7.5 7.5a1 1 0 011-1h3a1 1 0 110 2h-3a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                        <span>Work</span>
                    </button>
                    <button data-tag="Personal" class="tag-btn font-semibold py-2 px-4 rounded-full flex items-center gap-2">
                         <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 9a3 3 0 100-6 3 3 0 000 6zM10 11a6 6 0 00-6 6v1.5a.5.5 0 00.5.5h11a.5.5 0 00.5-.5V17a6 6 0 00-6-6z" /></svg>
                        <span>Personal</span>
                    </button>
                    <button data-tag="Study" class="tag-btn font-semibold py-2 px-4 rounded-full flex items-center gap-2">
                         <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3.5a1 1 0 00.028 1.846l7.307 2.923c.246.1.53.1.776 0l7.307-2.923a1 1 0 00.028-1.846l-7-3.5zM3 9.735v5.526c0 .414.336.75.75.75h12.5a.75.75 0 00.75-.75V9.735l-7.307 2.923a.998.998 0 01-.776 0L3 9.735z" /></svg>
                        <span>Study</span>
                    </button>
                </div>
                <div class="flex flex-col sm:flex-row gap-3">
                     <select id="priority-select" class="flex-1 p-3 border border-rose-200 rounded-lg bg-transparent text-slate-700 focus:outline-none pink-glow-focus">
                        <option value="low">Low Priority</option>
                        <option value="medium" selected>Medium Priority</option>
                        <option value="high">High Priority</option>
                    </select>
                    <input type="date" id="due-date-input" class="flex-1 p-3 border border-rose-200 rounded-lg bg-transparent text-slate-700 focus:outline-none pink-glow-focus">
                    <button id="add-task-btn" type="button" class="bg-pink-600 text-white font-semibold px-5 py-3 rounded-lg hover:bg-pink-700 focus:outline-none transition-transform transform hover:scale-105 pink-glow-focus-btn">Add Task</button>
                </div>
            </div>
            
            <!-- Controls: Filter & Sort -->
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4 border-t pt-4">
                <div id="filter-buttons" class="flex justify-center gap-2 bg-rose-100 p-1 rounded-lg">
                    <button data-filter="active" class="filter-btn font-semibold py-1 px-4 rounded-md text-slate-600">Active</button>
                    <button data-filter="completed" class="filter-btn font-semibold py-1 px-4 rounded-md text-slate-600">Completed</button>
                    <button data-filter="all" class="filter-btn font-semibold py-1 px-4 rounded-md text-slate-600">All</button>
                </div>
                <div class="flex items-center gap-2">
                     <label for="sort-select" class="text-sm font-medium text-slate-600">Sort by:</label>
                     <select id="sort-select" class="p-2 border border-rose-200 rounded-lg bg-transparent text-slate-700 text-sm focus:outline-none pink-glow-focus">
                        <option value="creation">Creation Date</option>
                        <option value="dueDate">Due Date</option>
                        <option value="priority">Priority</option>
                    </select>
                </div>
            </div>
            
            <!-- Task List & Celebration -->
            <div id="list-container" class="relative min-h-[150px]">
                <div id="task-list" class="space-y-3 transition-opacity duration-300">
                    <p id="empty-message" class="text-rose-500 text-center py-4">No tasks added yet. Let's start!</p>
                </div>
                <div id="celebration" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm flex-col items-center justify-center text-center p-8 rounded-lg celebration-anim">
                    <span class="text-5xl mb-4">ðŸ’–</span>
                    <h3 class="text-2xl font-bold text-pink-500">All Done for Today!</h3>
                    <p class="text-slate-600 mt-1">Great job, you're amazing!</p>
               </div>
            </div>
        </div>
    </div>

    <!-- Pomodoro Timer Modal -->
    <div id="pomodoro-modal" class="pomodoro-modal-bg fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="pomodoro-modal open bg-white border border-white/30 rounded-2xl shadow-lg p-8 w-full max-w-sm text-center">
            <h2 id="pomodoro-task-title" class="text-xl font-bold text-slate-800 mb-2">Focus on Task</h2>
            <p id="pomodoro-timer" class="text-6xl font-bold tabular-nums text-slate-900 mb-4">25:00</p>
            <div id="pomodoro-status" class="mb-6 text-lg font-medium text-pink-500">Time to focus!</div>
            <div class="flex justify-center gap-4">
                <button id="pomodoro-start-pause" class="w-24 bg-pink-600 text-white font-semibold px-5 py-3 rounded-lg hover:bg-pink-700 pink-glow-focus-btn">Start</button>
                <button id="pomodoro-reset" class="w-24 bg-rose-100 text-slate-800 font-semibold px-5 py-3 rounded-lg hover:bg-rose-200">Reset</button>
            </div>
            <button id="pomodoro-close" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
        </div>
    </div>


    <script>
        // DOM Elements
        const connectContainer = document.getElementById('connect-container');
        const appContainer = document.getElementById('app-container');
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const profileAvatar = document.getElementById('profile-avatar');
        const profileName = document.getElementById('profile-name');
        const profileAddress = document.getElementById('profile-address');
        const addTaskBtn = document.getElementById('add-task-btn'), taskInput = document.getElementById('task-input'), prioritySelect = document.getElementById('priority-select'), dueDateInput = document.getElementById('due-date-input'), taskList = document.getElementById('task-list'), emptyMessage = document.getElementById('empty-message'), filterButtonsContainer = document.getElementById('filter-buttons'), sortSelect = document.getElementById('sort-select'), todayDateEl = document.getElementById('today-date'), progressRing = document.getElementById('progress-ring'), dailyCompletedCount = document.getElementById('daily-completed-count'), tagSelector = document.getElementById('tag-selector'), celebrationEl = document.getElementById('celebration');
        const pomodoroModal = document.getElementById('pomodoro-modal'), pomodoroTaskTitle = document.getElementById('pomodoro-task-title'), pomodoroTimerEl = document.getElementById('pomodoro-timer'), pomodoroStatus = document.getElementById('pomodoro-status'), pomodoroStartPauseBtn = document.getElementById('pomodoro-start-pause'), pomodoroResetBtn = document.getElementById('pomodoro-reset'), pomodoroCloseBtn = document.getElementById('pomodoro-close');

        // App State
        let tasks = [], currentFilter = 'active', currentSort = 'creation', activeTag = null, selectedTag = null;
        let pomodoroState = { timerId: null, currentTaskIndex: -1, endTime: 0, isRunning: false, remainingSecondsOnPause: 25 * 60 };
        let currentUser = null;
        
        // --- Wallet & Profile Logic ---
        async function fetchProfileData(address) {
            const sweetNames = ["Starlight", "Sparkle", "Dreamer", "Cupcake", "Glimmer", "Candy", "Pixel", "Cosmo"];
            const nameIndex = parseInt(address.substring(2, 6), 16) % sweetNames.length;
            const secondNameIndex = parseInt(address.substring(6, 10), 16) % sweetNames.length;
            const hasENS = parseInt(address.substring(10, 12), 16) > 128;
            
            let displayName = `${sweetNames[nameIndex]} ${sweetNames[secondNameIndex]}`;
            if (hasENS) { displayName = `${sweetNames[nameIndex].toLowerCase()}.eth`; }

            const initials = displayName.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
            
            return {
                address: address,
                displayName: displayName,
                avatarUrl: `https://placehold.co/40x40/fbcfe8/db2777?text=${initials}`
            };
        }

        async function handleConnect() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another wallet extension!');
                return;
            }

            connectWalletBtn.disabled = true;
            connectWalletBtn.textContent = 'Connecting...';

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const account = accounts[0];
                currentUser = await fetchProfileData(account);
                localStorage.setItem('baseapp_connected_user_address', account);
                showAppScreen(currentUser);
            } catch (error) {
                console.error("User rejected connection request", error);
            } finally {
                connectWalletBtn.disabled = false;
                connectWalletBtn.textContent = 'Connect Wallet';
            }
        }

        async function handleDisconnect() {
            if (window.ethereum && window.ethereum.request) {
                try {
                    // This specific method is not standard but works for some wallets to clear permissions.
                    await window.ethereum.request({
                        method: "wallet_revokePermissions",
                        params: [{ eth_accounts: {} }]
                    });
                } catch (e) {
                    console.error("Could not revoke permissions. This may not be supported by your wallet.", e);
                }
            }
            currentUser = null;
            localStorage.removeItem('baseapp_connected_user_address');
            tasks = [];
            showConnectScreen();
        }


        function showConnectScreen() {
            connectContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }

        async function showAppScreen(user) {
            profileName.textContent = user.displayName;
            profileAddress.textContent = `${user.address.substring(0, 6)}...${user.address.substring(user.address.length - 4)}`;
            profileAvatar.src = user.avatarUrl;
            connectContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            loadTasks();
            renderTasks();
        }
        
        // --- Data Persistence ---
        function saveTasks() {
            if (!currentUser) return;
            localStorage.setItem(`miniapp_tasks_${currentUser.address}`, JSON.stringify(tasks));
        }
        function loadTasks() {
            if (!currentUser) return;
            const storedTasks = localStorage.getItem(`miniapp_tasks_${currentUser.address}`);
            tasks = storedTasks ? JSON.parse(storedTasks) : [];
        }
        function saveAndRender() { saveTasks(); renderTasks(); }

        // --- Core Rendering Logic ---
        function renderTasks() {
            taskList.innerHTML = '';
            let processedTasks = tasks.filter(task => {
                if (currentFilter === 'completed') return task.completed;
                if (currentFilter === 'active') return !task.completed;
                return true;
            }).filter(task => !activeTag || (task.tags && task.tags.includes(activeTag)));
            
            const priorityMap = { high: 3, medium: 2, low: 1 };
            processedTasks.sort((a, b) => {
                switch (currentSort) {
                    case 'priority': return (priorityMap[b.priority] || 0) - (priorityMap[a.priority] || 0);
                    case 'dueDate': if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate); if (a.dueDate) return -1; if (b.dueDate) return 1; return 0;
                    default: return b.id - a.id;
                }
            });

            if (processedTasks.length === 0) {
                 emptyMessage.style.display = 'block';
                 emptyMessage.textContent = tasks.length === 0 ? "Plan a fabulous day!" : "No tasks match your filters.";
                 taskList.appendChild(emptyMessage);
            } else {
                 emptyMessage.style.display = 'none';
            }
            
            processedTasks.forEach((task) => {
                const index = tasks.findIndex(t => t.id === task.id);
                const taskElement = document.createElement('div');
                
                const isOverdue = task.dueDate && !task.completed && new Date(task.dueDate) < new Date().setHours(0,0,0,0);
                const completedClass = task.completed ? 'bg-green-100/60 text-slate-500 line-through opacity-70' : 'bg-rose-50';
                const tagsHTML = (task.tags || []).map(tag => `<span class="rendered-tag text-xs font-semibold py-1 px-3 rounded-full" onclick="filterByTag('${tag}')">${tag}</span>`).join('');
                const pomodoroCountHTML = task.pomodoros > 0 ? `<span class="text-xs font-bold text-pink-500">${'âœ¨'.repeat(task.pomodoros)}</span>` : '';
                const focusButtonHTML = !task.completed ? `<button class="focus-btn text-slate-500 hover:text-pink-600 p-2 rounded-md" title="Focus on this task" onclick="openPomodoro(${index})"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>` : '';

                taskElement.className = `task-item p-4 rounded-lg transition-all duration-300 ${completedClass} priority-${task.priority}`;
                taskElement.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex items-start gap-3 flex-grow min-w-0">
                            <input type="checkbox" ${task.completed ? 'checked' : ''} class="mt-1 h-5 w-5 rounded border-rose-300 text-pink-500 focus:ring-pink-500 cursor-pointer bg-transparent" onchange="toggleTask(${index})">
                            <div class="min-w-0">
                                <div class="flex items-center gap-2 flex-wrap">
                                   <span class="font-medium text-slate-700 break-words">${task.text}</span>
                                   ${pomodoroCountHTML}
                                </div>
                                ${task.dueDate ? `<p class="text-xs ${isOverdue ? 'overdue-date' : 'text-slate-400'}">${new Date(task.dueDate).toLocaleDateString()}</p>` : ''}
                            </div>
                        </div>
                        <div class="actions flex items-center gap-1 opacity-0 transition-opacity flex-shrink-0 -mr-2">
                            ${focusButtonHTML}
                            <button class="delete-btn text-slate-500 hover:text-red-600 p-2 rounded-md" title="Delete task" onclick="deleteTask(${index})"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                        </div>
                    </div>
                    ${tagsHTML ? `<div class="mt-2 ml-8 flex flex-wrap gap-2">${tagsHTML}</div>` : ''}
                `;
                taskList.appendChild(taskElement);
            });
            updateDailyProgress();
            updateFilterButtons();
        }

        // --- Gamification & Progress ---
        function updateDailyProgress() {
            const todayStr = new Date().toDateString();
            const todaysTasks = tasks.filter(t => new Date(t.id).toDateString() === todayStr || (t.completedAt && new Date(t.completedAt).toDateString() === todayStr));
            const completedToday = todaysTasks.filter(t => t.completed && t.completedAt && new Date(t.completedAt).toDateString() === todayStr);
            const progress = todaysTasks.length > 0 ? (completedToday.length / todaysTasks.length) * 100 : 0;
            
            const circumference = 2 * Math.PI * 15.9155;
            const offset = circumference - progress / 100 * circumference;
            progressRing.style.strokeDashoffset = offset;
            dailyCompletedCount.textContent = completedToday.length;

            const listEl = document.getElementById('task-list');
            if (progress === 100 && todaysTasks.length > 0 && currentFilter !== 'completed') {
                celebrationEl.classList.remove('hidden');
                listEl.classList.add('opacity-0');
            } else {
                celebrationEl.classList.add('hidden');
                listEl.classList.remove('opacity-0');
            }
        }

        // --- Task Management ---
        function addTask() {
            const taskText = taskInput.value.trim();
            if (taskText) {
                tasks.push({ id: Date.now(), text: taskText, completed: false, priority: prioritySelect.value, dueDate: dueDateInput.value || null, tags: selectedTag ? [selectedTag] : [], pomodoros: 0 });
                taskInput.value = '';
                prioritySelect.value = 'medium';
                dueDateInput.value = '';
                selectedTag = null; 
                document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
                saveAndRender();
            }
        }
        function toggleTask(index) {
            tasks[index].completed = !tasks[index].completed;
            tasks[index].completedAt = tasks[index].completed ? Date.now() : null;
            saveAndRender();
        }

        // --- Initial Load & Event Listeners ---
        async function checkExistingConnection() {
            const savedAddress = localStorage.getItem('baseapp_connected_user_address');
            if (!savedAddress) { showConnectScreen(); return; }
            
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0 && accounts[0].toLowerCase() === savedAddress.toLowerCase()) {
                        currentUser = await fetchProfileData(savedAddress);
                        showAppScreen(currentUser);
                    } else {
                        // If saved address is no longer in the connected accounts, disconnect.
                        handleDisconnect();
                    }
                } catch (err) { console.error(err); showConnectScreen(); }
            } else { showConnectScreen(); }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            checkExistingConnection();
            todayDateEl.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            const radius = 15.9155;
            const circumference = 2 * Math.PI * radius;
            progressRing.style.strokeDasharray = `${circumference} ${circumference}`;
            progressRing.style.strokeDashoffset = circumference;
            document.querySelector('.filter-btn[data-filter="active"]').classList.add('active');
        });

        // --- Pomodoro & Notifications ---
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
        }
        function openPomodoro(index) {
            requestNotificationPermission();
            pomodoroTaskTitle.textContent = tasks[index].text;

            if (pomodoroState.isRunning && pomodoroState.currentTaskIndex !== index) {
                resetPomodoro(false);
            }
            
            pomodoroState.currentTaskIndex = index;
            if (!pomodoroState.isRunning) {
                const lastPausedSeconds = tasks[index].pomodoroPausedAt;
                pomodoroState.remainingSecondsOnPause = lastPausedSeconds !== undefined ? lastPausedSeconds : 25 * 60;
                updateTimerDisplay(pomodoroState.remainingSecondsOnPause);
            }
            pomodoroModal.classList.remove('hidden');
        }
        function closePomodoro() { pomodoroModal.classList.add('hidden'); }
        function pausePomodoro() {
            if (!pomodoroState.isRunning) return;
            clearInterval(pomodoroState.timerId);
            pomodoroState.isRunning = false;
            pomodoroState.remainingSecondsOnPause = Math.round((pomodoroState.endTime - Date.now()) / 1000);
            if(pomodoroState.currentTaskIndex !== -1) {
                tasks[pomodoroState.currentTaskIndex].pomodoroPausedAt = pomodoroState.remainingSecondsOnPause;
            }
            pomodoroStartPauseBtn.textContent = 'Start';
        }
        function resetPomodoro(updateDisplay = true) {
            clearInterval(pomodoroState.timerId);
            pomodoroState.isRunning = false;
            pomodoroState.remainingSecondsOnPause = 25 * 60;
            if (pomodoroState.currentTaskIndex !== -1) {
                delete tasks[pomodoroState.currentTaskIndex].pomodoroPausedAt;
            }
            pomodoroStatus.textContent = "Time to focus!";
            pomodoroStartPauseBtn.textContent = 'Start';
            if (updateDisplay) updateTimerDisplay(25 * 60);
        }
        function updateTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            pomodoroTimerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        function startPausePomodoro() {
            if (pomodoroState.isRunning) {
                pausePomodoro();
                return;
            }
            pomodoroState.isRunning = true;
            pomodoroStartPauseBtn.textContent = 'Pause';
            pomodoroState.endTime = Date.now() + pomodoroState.remainingSecondsOnPause * 1000;
            
            pomodoroState.timerId = setInterval(() => {
                const secondsLeft = Math.round((pomodoroState.endTime - Date.now()) / 1000);
                if (secondsLeft <= 0) {
                    clearInterval(pomodoroState.timerId);
                    handlePomodoroEnd();
                    return;
                }
                updateTimerDisplay(secondsLeft);
            }, 1000);
        }
        function handlePomodoroEnd() {
            if (pomodoroState.currentTaskIndex !== -1) {
                tasks[pomodoroState.currentTaskIndex].pomodoros = (tasks[pomodoroState.currentTaskIndex].pomodoros || 0) + 1;
                delete tasks[pomodoroState.currentTaskIndex].pomodoroPausedAt;
                saveAndRender();
            }
            pomodoroStatus.textContent = "Great job! Take a break.";
             if ('Notification' in window && Notification.permission === 'granted' && document.hidden) {
                new Notification("Time's up!", {
                    body: `Focus session for "${tasks[pomodoroState.currentTaskIndex].text}" is complete! Time for a break.`,
                    icon: 'https://placehold.co/192x192/fbcfe8/db2777?text=ðŸ’–'
                });
            }
            resetPomodoro(true);
        }


        // --- Event Listeners ---
        connectWalletBtn.addEventListener('click', handleConnect);
        disconnectBtn.addEventListener('click', handleDisconnect);
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0 || (currentUser && accounts[0].toLowerCase() !== currentUser.address.toLowerCase())) {
                    handleDisconnect();
                }
            });
        }
        addTaskBtn.addEventListener('click', addTask);
        taskInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addTask(); }});
        tagSelector.addEventListener('click', (e) => {
            const button = e.target.closest('.tag-btn');
            if (!button) return;
            const tag = button.dataset.tag;
            selectedTag = selectedTag === tag ? null : tag;
            document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tag === selectedTag));
        });
        sortSelect.addEventListener('change', (e) => { currentSort = e.target.value; renderTasks(); });
        filterButtonsContainer.addEventListener('click', (e) => {
            if (e.target.matches('.filter-btn')) {
                currentFilter = e.target.dataset.filter;
                renderTasks();
            }
        });
        pomodoroStartPauseBtn.addEventListener('click', startPausePomodoro);
        pomodoroResetBtn.addEventListener('click', () => resetPomodoro(true));
        pomodoroCloseBtn.addEventListener('click', closePomodoro);
        pomodoroModal.addEventListener('click', (e) => { if (e.target === pomodoroModal) closePomodoro(); });
        function deleteTask(index){ tasks.splice(index,1); saveAndRender(); }
        function updateFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === currentFilter));
        }
        function filterByTag(tag){ activeTag = activeTag === tag ? null : tag; renderTasks(); }
    </script>
</body>
</html>

